function toggleDetails(a){var b=$("tr.hidden-row-"+a),c=$("i#dropDown-activator-"+a);"none"===b.css("display")?(b.show(),c.removeClass("fa-angle-down"),c.addClass("fa-angle-up")):(b.hide(),c.removeClass("fa-angle-up"),c.addClass("fa-angle-down"))}function submitForm(a,b,c){$.ajax({method:$(b).attr("method"),url:a,data:{formData:$(b).serialize()},dataType:"json"}).done(function(a){a.status&&c&&c(a,b)})}function flashMessage(a,b,c){void 0==b&&(b="info");var d={allow_dismiss:!1,element:"body",type:b,offset:10,placement:{from:"top",align:"center"},delay:4e3,newest_on_top:!0};c&&(d.allow_dismiss=!0,d.delay=0),$.notify({message:a},d)}function format(a,b){return a.replace(/%(\d+)/g,function(a,c){return b[--c]})}function loadProject(a){currently_loaded_project=a;var b=new Date,c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear(),f={id:"changeTable",ajax_connector:paths.ajax_loadProject,pager_max_buttons:15,language:{dateFilter_range:Translator.trans("rewatajax.dateFilter_range"),filter:Translator.trans("rewatajax.filter"),search_results:Translator.trans("rewatajax.search_results"),search_text:Translator.trans("rewatajax.search_text"),no_entries_message:Translator.trans("rewatajax.no_entries_message")},daterangepicker:{maxDate:c+"."+d+"."+e,locale:{format:Translator.trans("lang.dateISO"),cancelLabel:"Clear",applyLabel:"Apply",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",weekLabel:"W",daysOfWeek:["Su","Mo","Tu","We","Th","Fr","Sa"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]},ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}},format:{dateISO:Translator.trans("lang.dateISO")}};$body.unbind("rewatajax.callConnector"),$body.unbind("rewatajax.createSearch");var g=$body.rewatajax(f,{project_id:a}).on("rewatajax.callConnector",function(b,c){c.flags.hasChanges?c.flags.hasCompleteChanges||flashMessage(Translator.trans("text.warning.incomplete_changes",{project_id:a}),"warning",!0):flashMessage(Translator.trans("text.warning.no_changes",{project_id:a}),"warning",!0),refreshGraph(c.statistics.xAxisLabels,c.statistics.datasets)}).on("rewatajax.createSearch",function(a,b){var c=document.createElement("div");c.className="input-group col-md-8";var d=document.createElement("div");d.className="input-group-btn";var e=document.createElement("button");e.id="export-changes",e.setAttribute("data-toggle","tooltip"),e.setAttribute("data-placement","top"),e.setAttribute("aria-haspopup","true"),e.setAttribute("aria-expanded","false"),e.title=Translator.trans("label.export_changelog"),e.className="btn btn-xs btn-success";var f=document.createElement("i");f.className="fa fa-file-text",e.appendChild(f),d.appendChild(e),c.appendChild(d),b.appendChild(c);var g=function(){var a=paths.ajax_change_export;$.ajax({method:"GET",url:a,data:{project_id:currently_loaded_project},dataType:"json"}).done(function(a){if(a.status){var b={header:a.modal.header,content:a.modal.content,footer:{buttons:{closeButton:{type:"close",class:"btn btn-default",text:"Close"},saveButton:{type:"submit",submitForm:"exportForm",class:"btn btn-primary",text:"Export"}}}},c=$("div#"+modalId);c.createModal(b),c.modal("show")}})};$body.unbind("click",g),$body.on("click","button#export-changes",g)});g.init();var h=function(a){return'<i class="fa fa-info" title="'+a+'" data-toggle="tooltip" data-placement="right"></i>'},i=function(){var a=$(this).data("id"),b="changeDetails-container-"+a,c="",d=$(this).data("type"),e=$(this).data("title"),f=$(this).data("editedtitle"),g=e;""!=f&&(c=Translator.trans("label.originalTitle")+": "+g,g=f);var i='<div class="form-group"><label for="titleInput">'+Translator.trans("label.changeTitle")+'</label><input type="text" class="form-control" id="titleInput" required value="'+g+'"><small class="form-text text-muted" id="titleInput-info">'+c+"</small></div>";i+='<div class="form-group"><label for="titleInput">'+Translator.trans("label.type")+'</label><select id="typeSelect" name="type" class="form-control">';for(var j in types){var k=types[j];i+=d==k?'<option value="'+k+'" selected>':'<option value="'+k+'">',""==k&&(k="undefined"),i+=Translator.trans("tag."+k),i+="</option>"}i+="</select>",i+="</div>",i+='<hr /><div id="'+b+'"></div>';var l={header:Translator.trans("title.changeDetails"),content:i,footer:{buttons:{closeButton:{type:"close",class:"btn btn-default",text:"Close"},"changeDetails-save":{type:"submit",class:"btn btn-primary",text:"Save changes"}}}},m=$("div#"+modalId);m.createModal(l),m.modal("show");var n=$("button#changeDetails-save");n.unbind("click"),n.click(function(){var b=$("div.modal-body input#titleInput").val(),c=b,d=!0;if(b!=f){b==e&&(b="",c=e,d=!1);var g=$("div.modal-body select#typeSelect option:selected"),i=g.val(),j=g.text();$.ajax({method:"POST",url:paths.ajax_change_details,data:{change_id:a,edited_title:b,type:i},dataType:"json"}).done(function(f){if(1==f.status){""==i&&(i="undefined");var g=$("button.changeDetailsButton[data-id="+a+"]"),k=g.parents("tr.rewatajax-row").find('td.rewatajax-column[data-type="showTitle"]');k.text(c);var l=g.parents("tr.rewatajax-row").find("td.rewatajax-column:nth-of-type(1)");l.html('<span class="badge badge-tag-'+i+'">'+j+"</span>"),g.data("type",i),g.data("editedtitle",b);var m=$("div.modal-body small#titleInput-info");if(m.html(""),d){var n=Translator.trans("label.originalTitle")+": "+e;k.append(" "+h(n)),m.html(n)}}})}});var o={id:"detailTable",ajax_connector:paths.ajax_change_details,pager_max_buttons:15,search:!1,language:{dateFilter_range:Translator.trans("rewatajax.dateFilter_range"),filter:Translator.trans("rewatajax.filter"),search_results:Translator.trans("rewatajax.search_results"),search_text:Translator.trans("rewatajax.search_text"),no_entries_message:Translator.trans("rewatajax.no_entries_message")},format:{dateISO:Translator.trans("lang.dateISO")}},p=$("div#"+b).rewatajax(o,{change_id:a});p.init()};$body.unbind("click",i),$body.on("click","button.changeDetailsButton",i)}function refreshGraph(a,b){window.chartColors={feature:"rgb(91,192,222)",task:"rgb(99,108,114)",bugfix:"rgb(217,83,79)",cleanup:"rgb(240,173,78)",undefined:"rgb(214,214,214)"};var c=[];for(var d in b)c.push({label:d,borderWidth:.5,borderColor:"#222",backgroundColor:window.chartColors[d],data:Object.values(b[d])});var e={type:"line",data:{labels:a,datasets:c},options:{responsive:!0,maintainAspectRatio:!1,title:{display:!1},tooltips:{mode:"index",intersect:!1,callbacks:{afterBody:function(a,b){var c=0;for(var d in a)c+=a[d].yLabel;return"--- "+Translator.trans("label.graphTooltip.total")+": "+c}}},hover:{mode:"index"},legend:{position:"bottom",labels:{generateLabels:function(a){labels=Chart.defaults.global.legend.labels.generateLabels(a);for(var b in labels)labels[b].text=Translator.trans("tag."+labels[b].text);return labels}}},scales:{xAxes:[{type:"time",time:{displayFormats:{day:Translator.trans("lang.dateISO")}},gridLines:{display:!1},ticks:{beginAtZero:!0,min:a[0],max:a[a.length-1]},scaleLabel:{display:!0,labelString:"Month"}}],yAxes:[{ticks:{display:!1,beginAtZero:!0,min:0,stepSize:1},stacked:!0,scaleLabel:{display:!0,labelString:"Changes"}}]}}};null!=window.myLineChart&&window.myLineChart.destroy();var f=document.getElementById("canvas").getContext("2d");1<c.length&&(window.myLineChart=new Chart(f,e),canvas.onclick=function(b){var c=myLineChart.getElementsAtEvent(b);if(c[0]){var d=c[0]._index,e=$("a#filter-date");e.popover("show"),window.setTimeout(function(){var b=e.attr("aria-describedby"),c=$("div#"+b+" > div.popover-content > input#date-dateFilter-range"),f=c.data("daterangepicker"),g=new Date(a[d]);f.setStartDate(g),f.setEndDate(g),f.clickApply()},0)}})}var $body=$("body div#body"),modalId="universalModal",currently_loaded_project=null;$(document).ready(function(){$("body").tooltip({selector:'[data-toggle="tooltip"]'}),$("button#button-project-add").click(function(){var a=paths.ajax_project_add;$.ajax({method:"GET",url:a,data:{},dataType:"json"}).done(function(b){if(b.status){var c={header:b.modal.header,content:b.modal.content,footer:{buttons:{closeButton:{type:"close",class:"btn btn-default",text:"Close"},saveButton:{type:"submit",submitForm:"projectForm",class:"btn btn-primary",text:"Save changes"}}}},d=$("div#"+modalId);d.createModal(c),d.modal("show"),$("form#projectForm").submit(function(b){b.preventDefault(),submitForm(a,this,function(a){if(a){d.modal("hide");var b=document.createElement("option");b.value=a.id,b.innerText=a.title,$("select#projectList").append(b)}})})}})}),$("button#button-project-details").click(function(){$.ajax({method:"GET",url:paths.ajax_project_details,data:{project_id:currently_loaded_project},dataType:"json"}).done(function(a){if(a.status){var b={header:a.modal.header,content:a.modal.content,footer:{buttons:{saveButton:{type:"submit",submitForm:"projectForm",class:"btn btn-primary",text:"Save changes"}}}},c=$("div#"+modalId);c.createModal(b),c.modal("show")}})}),$("button#fetchdata-button").click(function(){var a=currently_loaded_project,b=$("div#projectBar button"),c=$("div#projectBar select");b.hasClass("disabled")?console.log("Already working."):$.ajax({method:"POST",url:paths.ajax_cli_fetchData,data:{project_id:a},dataType:"json",beforeSend:function(a){b.addClass("disabled"),c.attr("disabled",!0)},error:function(a,b,c){flashMessage(b,"error")},complete:function(){b.removeClass("disabled"),c.attr("disabled",!1)}}).done(function(b){var c="error";b.status&&(c="success");var d=b.changes_count,e=Translator.trans("cli.no_new_changes_found");d>0&&(e=format(Translator.trans("cli.changes_fetched"),[d]),loadProject(a)),flashMessage(e,c)})})});